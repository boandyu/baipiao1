### 一、概述篇

#### 1.1 大厂面试题

> 支付宝：
>
> 支付宝三面：JVM 性能调优都做了什么？
>
> 小米：
>
> 有做过 JVM 内存优化吗？
>
> 从 SQL、JVM、架构、数据库四个方面讲讲优化思路
>
> 蚂蚁金服：
>
> JVM 的编译优化
>
> jvm 性能调优都做了什么
>
> JVM 诊断调优工具用过哪些？
>
> 二面：jvm 怎样调优，堆内存、栈空间设置多少合适
>
> 三面：JVM 相关的分析工具使用过的有哪些？具体的性能调优步骤如何
>
> 阿里：
>
> 如何进行 JVM 调优？有哪些方法？
>
> 如何理解内存泄漏问题？有哪些情况会导致内存泄漏？如何解决？
>
> 字节跳动：
>
> 三面：JVM 如何调优、参数怎么调？
>
> 拼多多：
>
> 从 SQL、JVM、架构、数据库四个方面讲讲优化思路
>
> 京东：
>
> JVM 诊断调优工具用过哪些？
>
> 每秒几十万并发的秒杀系统为什么会频繁发生 GC？
>
> 日均百万级交易系统如何优化 JVM？
>
> 线上生产系统 OOM 如何监控及定位与解决？
>
> 高并发系统如何基于 G1 垃圾回收器优化性能？

#### 1.2. 背景说明

**生产环境中的问题**

- 生产环境发生了内存溢出该如何处理？
- 生产环境应该给服务器分配多少内存合适？
- 如何对垃圾回收器的性能进行调优？
- 生产环境 CPU 负载飙高该如何处理？
- 生产环境应该给应用分配多少线程合适？
- 不加 log，如何确定请求是否执行了某一行代码？
- 不加 log，如何实时查看某个方法的入参与返回值？

**为什么要调优**

- 防止出现 OOM
- 解决 OOM
- 减少 Full GC 出现的频率

**不同阶段的考虑**

- 上线前
- 项目运行阶段
- 线上出现 OOM

#### 1.3. 调优概述

**监控的依据**

- 运行日志
- 异常堆栈
- GC 日志
- 线程快照
- 堆转储快照

**调优的大方向**

- 合理地编写代码
- 充分并合理的使用硬件资源
- 合理地进行 JVM 调优

#### 1.4. 性能优化的步骤

**第 1 步：性能监控**

- GC 频繁
- cpu load 过高
- OOM
- 内存泄露
- 死锁
- 程序响应时间较长

**第 2 步：性能分析**

- 打印 GC 日志，通过 GCviewer 或者 [http://gceasy.io](https://gitee.com/link?target=http%3A%2F%2Fgceasy.io) 来分析异常信息
- 灵活运用命令行工具、jstack、jmap、jinfo 等
- dump 出堆文件，使用内存分析工具分析文件
- 使用阿里 Arthas、jconsole、JVisualVM 来实时查看 JVM 状态
- jstack 查看堆栈信息

**第 3 步：性能调优**

- 适当增加内存，根据业务背景选择垃圾回收器
- 优化代码，控制内存使用
- 增加机器，分散节点压力
- 合理设置线程池线程数量
- 使用中间件提高程序效率，比如缓存、消息队列等
- 其他……

#### 1.5. 性能评价/测试指标

**停顿时间（或响应时间）**

提交请求和返回该请求的响应之间使用的时间，一般比较关注平均响应时间。常用操作的响应时间列表：

| 操作                                | 响应时间 |
| ----------------------------------- | -------- |
| 打开一个站点                        | 几秒     |
| 数据库查询一条记录（有索引）        | 十几毫秒 |
| 机械磁盘一次寻址定位                | 4 毫秒   |
| 从机械磁盘顺序读取 1M 数据          | 2 毫秒   |
| 从 SSD 磁盘顺序读取 1M 数据         | 0.3 毫秒 |
| 从远程分布式换成 Redis 读取一个数据 | 0.5 毫秒 |
| 从内存读取 1M 数据                  | 十几微妙 |
| Java 程序本地方法调用               | 几微妙   |
| 网络传输 2Kb 数据                   | 1 微妙   |

在垃圾回收环节中：

- 暂停时间：执行垃圾收集时，程序的工作线程被暂停的时间。
- -XX:MaxGCPauseMillis

**吞吐量**

- 对单位时间内完成的工作量（请求）的量度
- 在 GC 中：运行用户代码的事件占总运行时间的比例（总运行时间：程序的运行时间+内存回收的时间）
- 吞吐量为 1-1/(1+n)，其中-XX::GCTimeRatio=n

**并发数**

- 同一时刻，对服务器有实际交互的请求数

**内存占用**

- Java 堆区所占的内存大小

**相互间的关系**

以高速公路通行状况为例

- 吞吐量：每天通过高速公路收费站的车辆的数据
- 并发数：高速公路上正在行驶的车辆的数目
- 响应时间：车速